import { useEffect, useState } from 'react';
import { get, post, patch } from './lib/api';
import type { Announcement, CreateAnnouncementDto } from './types/announcement';
import './App.css';

export default function App() {
  const [announcements, setAnnouncements] = useState<Announcement[]>([]);
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [submitting, setSubmitting] = useState(false);

  // Fetch announcements on component mount
  useEffect(() => {
    fetchAnnouncements();
  }, []);

  const fetchAnnouncements = async () => {
    try {
      setLoading(true);
      setError('');
      const data = await get<Announcement[]>('/announcements');
      setAnnouncements(data);
    } catch (err) {
      setError('Failed to fetch announcements');
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!title.trim()) return;

    try {
      setSubmitting(true);
      setError('');
      
      const newAnnouncement: CreateAnnouncementDto = {
        title: title.trim(),
        description: description.trim() || undefined,
      };

      await post<Announcement>('/announcements', newAnnouncement);
      
      // Reset form
      setTitle('');
      setDescription('');
      
      // Refresh announcements
      await fetchAnnouncements();
    } catch (err) {
      setError('Failed to create announcement');
      console.error(err);
    } finally {
      setSubmitting(false);
    }
  };

  const handleStatusChange = async (id: string, status: 'active' | 'closed') => {
    try {
      setError('');
      await patch(`/announcements/${id}`, { status });
      
      // Update local state
      setAnnouncements((prev: Announcement[]) =>
        prev.map((announcement: Announcement) =>
          announcement.id === id ? { ...announcement, status } : announcement
        )
      );
    } catch (err) {
      setError('Failed to update announcement status');
      console.error(err);
    }
  };

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      weekday: 'short',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  };

  return (
    <div className="app">
      <div className="container">
        <h1>Residents Noticeboard</h1>
        
        {error && <div className="error">{error}</div>}
        
        {/* Add Announcement Form */}
        <section className="add-announcement">
          <h2>Add Announcement</h2>
          <form onSubmit={handleSubmit}>
            <div className="form-group">
              <label htmlFor="title">Title</label>
              <input
                id="title"
                type="text"
                placeholder="Required"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                disabled={submitting}
                required
              />
            </div>
            
            <div className="form-group">
              <label htmlFor="description">Description</label>
              <textarea
                id="description"
                placeholder="Optional"
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                disabled={submitting}
                rows={3}
              />
            </div>
            
            <button
              type="submit"
              disabled={!title.trim() || submitting}
              className="submit-btn"
            >
              {submitting ? 'Submitting...' : 'Submit'}
            </button>
          </form>
        </section>

        {/* Announcements List */}
        <section className="announcements">
          <h2>Announcements</h2>
          
          {loading ? (
            <div className="loading">Loading announcements...</div>
          ) : announcements.length === 0 ? (
            <div className="no-announcements">No announcements yet</div>
          ) : (
            <div className="announcements-list">
              {announcements.map((announcement) => (
                <div key={announcement.id} className="announcement-item">
                  <div className="announcement-content">
                    <h3 className="announcement-title">{announcement.title}</h3>
                    <div className="announcement-meta">
                      <span className={`status ${announcement.status}`}>
                        {announcement.status}
                      </span>
                      <span className="date">
                        {formatDate(announcement.createdAt)}
                      </span>
                    </div>
                    {announcement.description && (
                      <p className="announcement-description">
                        {announcement.description}
                      </p>
                    )}
                  </div>
                  
                  <div className="announcement-actions">
                    {announcement.status === 'active' ? (
                      <button
                        onClick={() => handleStatusChange(announcement.id, 'closed')}
                        className="close-btn"
                      >
                        Close
                      </button>
                    ) : (
                      <button
                        onClick={() => handleStatusChange(announcement.id, 'active')}
                        className="reopen-btn"
                      >
                        Reopen
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </section>
      </div>
    </div>
  );
}